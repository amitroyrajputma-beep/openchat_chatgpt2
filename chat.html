<!DOCTYPE html>
<html>
<head>
  <title>Chat Room</title>
  <style>
    video{width:45%;border:1px solid}
  </style>
</head>
<body>

<h3 id="room"></h3>

<video id="local" autoplay muted></video>
<video id="remote" autoplay></video><br><br>
<button onclick="startCall()">Start Video Call</button>

<hr>

<div id="chat" style="height:200px;overflow:auto;border:1px solid"></div>
<input id="msg">
<button onclick="send()">Send</button>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase.js"></script>

<script>
const q=new URLSearchParams(location.search);
const room=q.get("room"), name=q.get("name");
document.getElementById("room").innerText="Room: "+room;

// TEXT CHAT
firebase.database().ref("chats/"+room)
.on("child_added",s=>{
  chat.innerHTML+=`<div><b>${s.val().name}:</b> ${s.val().msg}</div>`;
});

function send(){
  firebase.database().ref("chats/"+room).push({
    name,msg:msg.value,time:Date.now()
  });
  msg.value="";
}

// VIDEO CALL
let pc=new RTCPeerConnection({
  iceServers:[{urls:"stun:stun.l.google.com:19302"}]
});

navigator.mediaDevices.getUserMedia({video:true,audio:true})
.then(s=>{
  local.srcObject=s;
  s.getTracks().forEach(t=>pc.addTrack(t,s));
});

pc.ontrack=e=>remote.srcObject=e.streams[0];
pc.onicecandidate=e=>{
  if(e.candidate)
    firebase.database()
      .ref("calls/"+room+"/candidates")
      .push(JSON.stringify(e.candidate));
};

async function startCall(){
  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);
  firebase.database().ref("calls/"+room+"/offer")
    .set(JSON.stringify(offer));
}

firebase.database().ref("calls/"+room+"/offer")
.on("value",async s=>{
  if(!s.exists()||pc.currentRemoteDescription) return;
  await pc.setRemoteDescription(JSON.parse(s.val()));
  const ans=await pc.createAnswer();
  await pc.setLocalDescription(ans);
  firebase.database().ref("calls/"+room+"/answer")
    .set(JSON.stringify(ans));
});

firebase.database().ref("calls/"+room+"/answer")
.on("value",async s=>{
  if(s.exists()&&!pc.currentRemoteDescription)
    pc.setRemoteDescription(JSON.parse(s.val()));
});

firebase.database().ref("calls/"+room+"/candidates")
.on("child_added",s=>{
  pc.addIceCandidate(new RTCIceCandidate(JSON.parse(s.val())));
});
</script>

</body>
</html>
